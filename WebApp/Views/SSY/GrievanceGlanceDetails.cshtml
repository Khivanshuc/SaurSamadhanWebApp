@model WebApp.Models.VwGrievanceModel

<style>

    #detailtable th {
        font-weight: bold;
        width: 36%;
        vertical-align: top;
    }

    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        padding-top: 60px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.9);
    }

    /* Modal Content (image) */
    .modal-content {
        margin: auto;
        display: block;
        width: auto;
        height:auto;
        max-width: 500px;
    }

    /* Add Animation */
    .modal-content, .close {
        animation-name: zoom;
        animation-duration: 0.6s;
    }

    @@keyframes zoom {
        from {
            transform: scale(0)
        }

        to {
            transform: scale(1)
        }
    }

    /* The Close Button */
    .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        z-index: 1300;
    }

    .close:hover,
    .close:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }

    /* Zoom Buttons */
    .zoom-btn {
        border-radius: 14px;
        position: inherit;
        bottom: 20px;
        right: 20px;
        color: black;
        font-size: 30px;
        padding: 10px 20px;
        background-color: lightgray;
        cursor: pointer;
    }

    #zoomIn {
        margin-right: 5px;
        right: 70px;
    }

    #zoomOut {
        right: 20px;
    }

    @@media (max-width: 600px) {
        img {
            height: 130px !important;
        }

        .btn{

        }

    }
</style> 


<div>
    <h4> Grievance - Report</h4>
</div>
<div class="row justify-content-center mt-md-3">
    <div class="col-md-6">
        <table class="table table-bordered" id="detailtable">
            <tbody>
                <tr>
                    <th>Complaint Id:</th>
                    <td>@Html.DisplayFor(model => model.Id)</td>
                </tr>
                <tr>
                    <th>District:</th>
                    <td>@Html.DisplayFor(model => model.DistrictName)</td>
                </tr>
                <tr>
                    <th>Block:</th>
                    <td>@Html.DisplayFor(model => model.BlockName)</td>
                </tr>
                <tr>
                    <th>Village:</th>
                    <td>@Html.DisplayFor(model => model.VillageName)</td>
                </tr>
                <tr>
                    <th>Region:</th>
                    <td>@Html.DisplayFor(model => model.Region)</td>
                </tr>
                <tr>
                    <th>Applicant's Name:</th>
                    <td>@Html.DisplayFor(model => model.ApplicantName)</td>
                </tr>
                <tr>
                    <th>Site:</th>
                    <td>@Html.DisplayFor(model => model.SiteName)</td>
                </tr>
                <tr>
                    <th>Project Name:</th>
                    <td>@Html.DisplayFor(model => model.ProjectName)</td>
                </tr>
                <tr>
                    <th>System Integrator:</th>
                    <td>@Html.DisplayFor(model => model.SIName)</td>
                </tr>
                <tr>
                    <th>Fault Remark:</th>
                    <td>@Html.DisplayFor(model => model.FaultRemark)</td>
                </tr>
                <tr>
                    <th>GeoTag:</th>
                    <td>@Html.DisplayFor(model => model.FaultImageGeoTag)</td>
                </tr>

                <tr>
                    <th>Applicant's Mobile Number:</th>
                    <td>@Html.DisplayFor(model => model.MobileNumber)</td>
                </tr>
                <tr>
                    <th>Complaint Date:</th>
                    <td>@Html.DisplayFor(model => model.CreatedOn)</td>
                </tr>
                <tr>
                    <th>Severity:</th>
                    <td>@Html.DisplayFor(model => model.Severity)</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <table class="table table-bordered" id="table">
            <tbody>

                <tr>
                    <th>Fault Image:</th>
                    <td>
                        @if (!string.IsNullOrEmpty(Model.FaultImageBase64))
                        {
                            <img class="clickable-image" width="150px" height="150px" src="data:@Model.FaultImageType;base64,@Model.FaultImageBase64" alt="Fault Image" />
                        }
                        else
                        {
                            <p>
                                No image has been uploaded by the CREDA official yet
                            </p>
                        }
                    </td>
                </tr>
                <tr>
                    <th>Image after Rectification:</th>
                    <td>
                        @if (!string.IsNullOrEmpty(Model.MobilePhotoBase64))
                        {
                            <img class="clickable-image" width="150px" height="150px" src="data:@Model.MobilePhotoType;base64,@Model.MobilePhotoBase64" alt="Mobile Photo" />
                        }
                        else
                        {
                            <p>
                                No image has been uploaded by the CREDA official yet
                            </p>
                        }
                    </td>
                </tr>

                <tr>
                    <th>Assigned To:</th>
                    <td>@Html.DisplayFor(model => model.AssignTo)</td>
                </tr>
                <tr>
                    <th>Assigned Date:</th>
                    <td>@Html.DisplayFor(model => model.OpenDate)</td>
                </tr>
                <tr>
                    <th>Remark by CREDA Official:</th>
                    <td>@Html.DisplayFor(model => model.AdminComment)</td>
                </tr>
                <tr>
                    <th>Remark after Verification:</th>
                    <td>@Html.DisplayFor(model => model.VerifyComment)</td>
                </tr>
                <tr>
                    <th>Verification Date:</th>
                    <td>@Html.DisplayFor(model => model.VerifyDate)</td>
                </tr>
                <tr>
                    <th>Complaint Closing Date:</th>
                    <td>@Html.DisplayFor(model => model.CloseDate)</td>
                </tr>
                <tr>
                    <th>Grievance Status:</th>
                    <td>@Html.DisplayFor(model => model.GrievanceStatus)</td>
                </tr>
                <tr>
                    <th>Certificate Photo:</th>
                    <td>
                        @if (!string.IsNullOrEmpty(Model.CertificatePhotoBase64))
                        {
                            <img id="certificateimage" style="display: none;" src="data:application/pdf;base64,@Model.CertificatePhotoBase64" />
                            <button type="button" onclick="previewGrievanceCertificatePDF()">Preview PDF</button>
                            <button type="button" onclick="downloadGrievanceCertificatePDF()">Download PDF</button>
                        }
                        else
                        {
                            <p>No PDF has been uploaded by the CREDA official yet</p>
                        }
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying the image -->
    <div id="imageModal" class="image-modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
        <div id="zoomIn" class="zoom-btn">+</div>
        <div id="zoomOut" class="zoom-btn">-</div>
    </div>

</div>


<script>
    function downloadGrievanceCertificatePDF() {
        const image = document.getElementById('certificateimage');
        let base64String = image.src;

        console.log("base64String", base64String);

        // Check if the Base64 string is a PDF
        if (base64String.startsWith("data:application/pdf;base64,") || base64String.startsWith("JVBERi0")) {
            // Remove the prefix if present
            const base64Data = base64String.startsWith("data:application/pdf;base64,")
                ? base64String.replace("data:application/pdf;base64,", "")
                : base64String;
            //console.log(base64String);



            // Convert Base64 string to binary data
            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);

            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // Create a Blob object
            const blob = new Blob([bytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);

            const tempLink = document.createElement('a');
            tempLink.href = url;
            tempLink.download = 'GrievanceFile.pdf';
            document.body.appendChild(tempLink); // Append to the DOM
            tempLink.click(); // Trigger the download
            document.body.removeChild(tempLink); // Remove from the DOM

            // Clean up
            URL.revokeObjectURL(url);
        } else {
            alert("Not a valid Base64 PDF string. Please check");
        }
    }

    function previewGrievanceCertificatePDF() {
        const image = document.getElementById('certificateimage');
        let base64String = image.src;

        if (base64String.startsWith("data:application/pdf;base64,") || base64String.startsWith("JVBERi0")) {
            const base64Data = base64String.startsWith("data:application/pdf;base64,")
                ? base64String.replace("data:application/pdf;base64,", "")
                : base64String;

            const binaryString = window.atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);

            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            const blob = new Blob([bytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);

            window.open(url); // Open the PDF in a new tab

            URL.revokeObjectURL(url); // Clean up
        } else {
            alert("Not a valid Base64 PDF string. Please check");
        }
    }
    // Get the modal
    var modal = document.getElementById('imageModal');
    var modalImg = document.getElementById("modalImage");

    // Get the images and attach click event
    var images = document.getElementsByClassName('clickable-image');
    for (var i = 0; i < images.length; i++) {
        images[i].onclick = function () {
            modal.style.display = "block";
            modalImg.src = this.src;
        }
    }

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }

    // Zoom functionality
    var zoomLevel = 1;
    document.getElementById('zoomIn').onclick = function () {
        zoomLevel += 0.1;
        modalImg.style.transform = `scale(${zoomLevel})`;
    }

    document.getElementById('zoomOut').onclick = function () {
        if (zoomLevel > 0.1) {
            zoomLevel -= 0.1;
            modalImg.style.transform = `scale(${zoomLevel})`;
        }
    }

</script>